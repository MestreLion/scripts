#!/bin/bash

myname="${0##*/}"

usage() {
	msg="$1\nUsage: $myname <FILE|DIR> <FILE|DIR> <FILE|DIR>\n"
	msg="${msg//&/&amp;}"
	msg="${msg//</&lt;}"
	if [[ "$TERM" == "dumb" ]] && type zenity >/dev/null 2>&1 ; then
		zenity --info --no-wrap --text "$msg"
	else
		printf "%b" "$msg" >&2
	fi
	exit 1
}

md5sumdir() (
	cd "$1"
	find . -type f -exec md5sum {} + | LC_ALL=C sort -f --key=2
)

file_or_dir() {
	[[ -f "$1" ]] && { hexdump -C "$1" ; return ; }
	[[ -d "$1" ]] && { md5sumdir "$1"  ; return ; }
}

#Do NOT use in subshells!
create_tempfile()
{
	# See if this was called before
	if [[ "$tempfile" ]]; then
		# "push" previous file to end of array
		tempfile+=( "$tempfile" )
	else
		:
		# set the trap with swapped quotes for delayed array evaluation
		trap 'rm -f -- "${tempfile[@]}"' EXIT
	fi

	# set new file
	tempfile=$(tempfile --prefix "_" --suffix "_${1//\//_}")
}

case $# in
	2|3)
		while (( $# )) ; do
			create_tempfile "$1"
			file_or_dir "$1" > "$tempfile"
			shift
		done
	;;
	*) usage "$myname requires either 2 or 3 arguments";;
esac

meld "${tempfile[@]}"
